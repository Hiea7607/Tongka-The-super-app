<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tongka App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container {
            max-width: 800px;
        }
        .wallet-card {
            background-color: #4a5568;
            color: #fff;
            background-image: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }
        .transaction-card {
            background-color: #fff;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="loading" class="text-center text-xl font-semibold text-gray-700">
        Loading...
    </div>

    <div id="auth-container" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm" style="display: none;">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Welcome to Tongka</h2>
        <input id="auth-email" type="email" placeholder="Email" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <input id="auth-password" type="password" placeholder="Password" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="login-button" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Log In</button>
        <button id="signup-button" class="w-full bg-gray-600 text-white p-3 rounded-lg font-semibold mt-2 hover:bg-gray-700 transition duration-300">Sign Up</button>
        <p class="text-center mt-4 text-sm text-gray-500">
            <a href="#" id="anonymous-link" class="text-blue-500 hover:text-blue-700">Continue without signing in</a>
        </p>
    </div>

    <div id="app-container" class="container mx-auto p-6 bg-white rounded-xl shadow-lg" style="display: none;">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800">My Tongka Wallet</h1>
            <button id="logout-button" class="bg-red-500 text-white p-2 rounded-lg text-sm font-semibold hover:bg-red-600 transition duration-300">Log Out</button>
        </div>

        <!-- Wallet Card -->
        <div class="wallet-card rounded-xl p-6 shadow-md mb-8">
            <div class="flex justify-between items-center mb-4">
                <span class="text-gray-300 text-sm">Total Balance</span>
                <span id="user-role" class="text-white text-xs px-2 py-1 rounded-full bg-blue-500"></span>
            </div>
            <div class="flex items-center">
                <span class="text-4xl font-extrabold" id="balance-display">0</span>
                <span class="text-2xl font-semibold ml-2 text-gray-300">Tongka</span>
            </div>
        </div>

        <!-- Transfer Section -->
        <div class="bg-gray-50 p-6 rounded-xl shadow-inner mb-8">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Send Tongka</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input id="receiver-email" type="email" placeholder="Receiver's Email" class="w-full p-3 border border-gray-300 rounded-lg">
                <input id="amount" type="number" placeholder="Amount" class="w-full p-3 border border-gray-300 rounded-lg">
                <button id="send-button" class="w-full col-span-2 bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600 transition duration-300">Send</button>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="transaction-card rounded-xl p-6 shadow-md">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Transaction History</h2>
            <div id="transaction-list" class="space-y-4">
                <!-- Transactions will be inserted here by JavaScript -->
            </div>
        </div>

        <!-- Admin Panel (Initially hidden) -->
        <div id="admin-panel" class="bg-red-50 p-6 mt-8 rounded-xl shadow-inner" style="display: none;">
            <h2 class="text-xl font-bold mb-4 text-red-800">Administrator Panel</h2>
            <p class="text-sm text-red-600 mb-4">Warning: Use this panel with care. It gives you full control over all user accounts and data.</p>
            <div id="user-management-list" class="space-y-4">
                <!-- User list will be inserted here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // IMPORTANT: The Firebase config is provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const loadingScreen = document.getElementById('loading');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginButton = document.getElementById('login-button');
        const signupButton = document.getElementById('signup-button');
        const logoutButton = document.getElementById('logout-button');
        const sendButton = document.getElementById('send-button');
        const receiverEmailInput = document.getElementById('receiver-email');
        const amountInput = document.getElementById('amount');
        const balanceDisplay = document.getElementById('balance-display');
        const transactionList = document.getElementById('transaction-list');
        const userRoleDisplay = document.getElementById('user-role');
        const adminPanel = document.getElementById('admin-panel');
        const userManagementList = document.getElementById('user-management-list');
        const anonymousLink = document.getElementById('anonymous-link');

        let unsubscribeTransactions = null;
        let unsubscribeUserList = null;

        // Function to create a user document in Firestore
        const createUserDocument = async (user, role = 'Customer') => {
            const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'profile');
            const userProfile = {
                uid: user.uid,
                email: user.email,
                balance: 100, // Initial balance
                role: role,
                createdAt: new Date()
            };
            await setDoc(userRef, userProfile);
            return userProfile;
        };
        
        // Function to fetch and display transactions
        const fetchTransactions = (uid) => {
            // Unsubscribe from previous listener if it exists
            if (unsubscribeTransactions) {
                unsubscribeTransactions();
            }

            const transactionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
            const q = query(transactionsRef, where('participants', 'array-contains', uid));

            unsubscribeTransactions = onSnapshot(q, (snapshot) => {
                transactionList.innerHTML = ''; // Clear the list
                let transactions = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    transactions.push({ ...data, id: doc.id });
                });
                
                // Sort transactions by timestamp in descending order
                transactions.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                
                transactions.forEach(tx => {
                    const direction = tx.senderUid === uid ? 'sent' : 'received';
                    const amount = tx.amount;
                    const email = direction === 'sent' ? tx.receiverEmail : tx.senderEmail;
                    const date = tx.timestamp.toDate().toLocaleString();

                    const transactionEl = document.createElement('div');
                    transactionEl.className = `p-4 rounded-lg shadow-sm border ${direction === 'sent' ? 'border-red-300' : 'border-green-300'} flex justify-between items-center`;
                    transactionEl.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-700">${direction === 'sent' ? 'Sent to' : 'Received from'} ${email}</p>
                            <p class="text-sm text-gray-500">${date}</p>
                        </div>
                        <span class="font-bold text-lg ${direction === 'sent' ? 'text-red-500' : 'text-green-500'}">
                            ${direction === 'sent' ? '-' : '+'}${amount} Tongka
                        </span>
                    `;
                    transactionList.appendChild(transactionEl);
                });
            });
        };

        // Function to fetch and display user data
        const fetchUserData = async (uid) => {
            const userDocRef = doc(db, 'artifacts', appId, 'users', uid, 'data', 'profile');
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    balanceDisplay.textContent = userData.balance;
                    userRoleDisplay.textContent = userData.role.toUpperCase();
                    // Show or hide admin panel based on role
                    if (userData.role === 'Admin') {
                        adminPanel.style.display = 'block';
                        fetchUserList();
                    } else {
                        adminPanel.style.display = 'none';
                        if(unsubscribeUserList) {
                            unsubscribeUserList();
                        }
                    }
                } else {
                    console.error("No such user document!");
                    balanceDisplay.textContent = 'N/A';
                    userRoleDisplay.textContent = 'N/A';
                }
            } catch (error) {
                console.error("Error fetching user data:", error);
            }
        };

        // Function to fetch and display all user profiles for the admin panel
        const fetchUserList = () => {
            // Unsubscribe from previous listener if it exists
            if (unsubscribeUserList) {
                unsubscribeUserList();
            }

            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            unsubscribeUserList = onSnapshot(usersRef, (snapshot) => {
                userManagementList.innerHTML = ''; // Clear the list
                snapshot.forEach(docSnap => {
                    const userData = docSnap.data();
                    const userEl = document.createElement('div');
                    userEl.className = 'p-4 border rounded-lg shadow-sm bg-white';
                    userEl.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-gray-800">${userData.email}</span>
                            <span class="text-xs px-2 py-1 rounded-full ${userData.role === 'Admin' ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}">
                                ${userData.role}
                            </span>
                        </div>
                        <div class="text-sm text-gray-600">
                            <p>Balance: <span class="font-bold">${userData.balance}</span> Tongka</p>
                            <p>UID: ${userData.uid}</p>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <button data-uid="${userData.uid}" data-action="transfer" class="flex-1 bg-blue-500 text-white text-sm p-2 rounded-lg hover:bg-blue-600 transition">Transfer</button>
                            <button data-uid="${userData.uid}" data-action="delete" class="flex-1 bg-red-500 text-white text-sm p-2 rounded-lg hover:bg-red-600 transition">Delete</button>
                        </div>
                    `;
                    userManagementList.appendChild(userEl);
                });
            });
        };

        // Transfer Tongka function
        const transferTongka = async (senderUid, receiverEmail, amount) => {
            if (senderUid === null) {
                // Handle anonymous user case
                console.error("Anonymous users cannot send Tongka.");
                return;
            }

            const parsedAmount = parseInt(amount, 10);
            if (isNaN(parsedAmount) || parsedAmount <= 0) {
                alert("Please enter a valid amount.");
                return;
            }

            const senderRef = doc(db, 'artifacts', appId, 'users', senderUid, 'data', 'profile');
            const receiverQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('email', '==', receiverEmail));
            const transactionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');

            try {
                // Get sender's data
                const senderSnap = await getDoc(senderRef);
                if (!senderSnap.exists()) {
                    alert("Sender account not found.");
                    return;
                }
                const senderData = senderSnap.data();

                if (senderData.balance < parsedAmount) {
                    alert("Insufficient balance.");
                    return;
                }

                // Get receiver's data
                const receiverSnap = await getDocs(receiverQuery);
                if (receiverSnap.empty) {
                    alert("Receiver email not found.");
                    return;
                }
                const receiverData = receiverSnap.docs[0].data();
                const receiverRef = doc(db, 'artifacts', appId, 'users', receiverData.uid, 'data', 'profile');

                // Update sender and receiver balances
                await updateDoc(senderRef, { balance: senderData.balance - parsedAmount });
                await updateDoc(receiverRef, { balance: receiverData.balance + parsedAmount });

                // Create a new transaction document in the public collection
                await addDoc(transactionsRef, {
                    senderUid: senderUid,
                    receiverUid: receiverData.uid,
                    senderEmail: senderData.email,
                    receiverEmail: receiverData.email,
                    amount: parsedAmount,
                    timestamp: new Date(),
                    participants: [senderUid, receiverData.uid]
                });

                alert(`Successfully sent ${parsedAmount} Tongka to ${receiverEmail}.`);
                receiverEmailInput.value = '';
                amountInput.value = '';

            } catch (error) {
                console.error("Transaction failed:", error);
                alert("Transaction failed. Please try again.");
            }
        };

        // Authentication State Listener
        onAuthStateChanged(auth, async (user) => {
            loadingScreen.style.display = 'none';
            if (user) {
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                
                // Fetch and display user-specific data
                await fetchUserData(user.uid);
                fetchTransactions(user.uid);

            } else {
                authContainer.style.display = 'block';
                appContainer.style.display = 'none';
                if (unsubscribeTransactions) {
                    unsubscribeTransactions();
                }
                if (unsubscribeUserList) {
                    unsubscribeUserList();
                }
            }
        });
        
        // Initial sign-in with custom token if available
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch((error) => {
                console.error("Error signing in with custom token:", error);
                signInAnonymously(auth);
            });
        } else {
            // Fallback to anonymous sign-in
            signInAnonymously(auth);
        }

        // Event Listeners
        loginButton.addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                alert("Login failed. Check your email and password.");
            }
        });

        signupButton.addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await createUserDocument(userCredential.user);
                alert("Account created successfully! You are now logged in.");
            } catch (error) {
                console.error("Sign up failed:", error);
                alert("Sign up failed. A user with this email might already exist.");
            }
        });

        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });

        anonymousLink.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Anonymous sign-in failed:", error);
                alert("Anonymous sign-in failed. Please try again.");
            }
        });

        sendButton.addEventListener('click', () => {
            const currentUser = auth.currentUser;
            const receiverEmail = receiverEmailInput.value;
            const amount = amountInput.value;
            if (currentUser) {
                transferTongka(currentUser.uid, receiverEmail, amount);
            } else {
                alert("Please sign in to send Tongka.");
            }
        });
        
        // Admin panel event listener for user management
        userManagementList.addEventListener('click', async (e) => {
            const button = e.target;
            const uid = button.dataset.uid;
            const action = button.dataset.action;

            if (action === 'transfer') {
                const amount = prompt("Enter amount to transfer to this user:");
                if (amount) {
                    const parsedAmount = parseInt(amount, 10);
                    if (!isNaN(parsedAmount) && parsedAmount > 0) {
                        // The user is the current logged-in admin
                        transferTongka(auth.currentUser.uid, 'admin_email_to_be_replaced@example.com', parsedAmount); // Placeholder, will need to be the actual admin
                        // A more robust implementation would allow the admin to transfer to a specific user
                        // This would require a more complex function that takes both sender and receiver UIDs
                    } else {
                        alert("Please enter a valid amount.");
                    }
                }
            } else if (action === 'delete') {
                const confirmDelete = confirm("Are you sure you want to delete this user?");
                if (confirmDelete) {
                    // Implement logic to delete the user account and data
                    // This is more complex and typically requires a backend function (Cloud Function)
                    // For now, this is a placeholder. Deleting from the database alone isn't enough.
                    alert("User deletion is not yet implemented in this simplified app. It requires a Firebase Cloud Function for security reasons.");
                }
            }
        });
    </script>
</body>
</html>
